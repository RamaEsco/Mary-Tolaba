-- =============================================
-- CONFIGURACIÓN INICIAL DE LA BASE DE DATOS
-- =============================================

-- Crear la tabla de productos
CREATE TABLE IF NOT EXISTS public.productos (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre TEXT NOT NULL,
    descripcion TEXT,
    precio DECIMAL(10, 2) NOT NULL,
    categoria TEXT NOT NULL,
    imagen TEXT,
    stock INTEGER DEFAULT 0,
    fecha_creacion TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Crear índices para mejorar el rendimiento
CREATE INDEX IF NOT EXISTS idx_productos_categoria ON public.productos(categoria);
CREATE INDEX IF NOT EXISTS idx_productos_activo ON public.productos(activo);
CREATE INDEX IF NOT EXISTS idx_productos_created_at ON public.productos(created_at);

-- Habilitar RLS (Row Level Security) si no está habilitado
ALTER TABLE public.productos ENABLE ROW LEVEL SECURITY;

-- Políticas de seguridad (RLS)
-- Nota: Ajusta estas políticas según tus necesidades de seguridad

-- Permitir acceso público a productos activos
CREATE POLICY "Acceso público a productos activos" 
ON public.productos 
FOR SELECT 
USING (activo = true);

-- Permitir inserción solo a usuarios autenticados (si usas autenticación)
CREATE POLICY "Permitir inserción a usuarios autenticados"
ON public.productos
FOR INSERT
WITH CHECK (true);

-- Permitir actualización solo a usuarios autenticados
CREATE POLICY "Permitir actualización a usuarios autenticados"
ON public.productos
FOR UPDATE
USING (true);

-- Permitir eliminación solo a usuarios autenticados
CREATE POLICY "Permitir eliminación a usuarios autenticados"
ON public.productos
FOR DELETE
USING (true);

-- =============================================
-- DATOS DE EJEMPLO
-- =============================================

-- Insertar datos de ejemplo (solo si la tabla está vacía)
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM public.productos LIMIT 1) THEN
        INSERT INTO public.productos (nombre, descripcion, precio, categoria, imagen) VALUES
        ('Blusa de verano', 'Blusa ligera de algodón', 29.99, 'ropa', 'https://via.placeholder.com/300x300?text=Blusa+de+verano'),
        ('Perfume floral', 'Fragancia suave y duradera', 59.99, 'perfume', 'https://via.placeholder.com/300x300?text=Perfume+floral'),
        ('Tupper pequeño', 'Hermético para alimentos', 12.99, 'hermeticos', 'https://via.placeholder.com/300x300?text=Tupper'),
        ('Collar de plata', 'Elegante collar plateado', 24.99, 'bisuteria', 'https://via.placeholder.com/300x300?text=Collar');
    END IF;
END $$;

-- =============================================
-- CONSULTAS ÚTILES
-- =============================================

-- Obtener todos los productos activos
-- SELECT * FROM public.productos WHERE activo = true ORDER BY created_at DESC;

-- Buscar productos por categoría
-- SELECT * FROM public.productos WHERE categoria = 'ropa' AND activo = true;

-- Actualizar un producto
-- UPDATE public.productos 
-- SET nombre = 'Nuevo nombre', 
--     precio = 34.99, 
--     categoria = 'nueva_categoria',
--     descripcion = 'Nueva descripción',
--     imagen = 'nueva_imagen.jpg',
--     stock = 10,
--     activo = true
-- WHERE id = 1;

-- Desactivar un producto (eliminación lógica)
-- UPDATE public.productos SET activo = false WHERE id = 1;

-- Buscar productos por nombre o descripción
-- SELECT * FROM public.productos 
-- WHERE (nombre ILIKE '%busqueda%' OR descripcion ILIKE '%busqueda%') 
-- AND activo = true;

-- Obtener el conteo de productos por categoría
-- SELECT categoria, COUNT(*) as cantidad 
-- FROM public.productos 
-- WHERE activo = true 
-- GROUP BY categoria 
-- ORDER BY cantidad DESC;

-- Tabla para las publicaciones
CREATE TABLE public.publicaciones (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    titulo TEXT NOT NULL,
    contenido TEXT NOT NULL,
    fecha_publicacion TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
    autor_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    fecha_actualizacion TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
    estado TEXT DEFAULT 'borrador'::text CHECK (estado IN ('borrador', 'publicado', 'archivado'))
);

-- Tabla para las imágenes de las publicaciones
CREATE TABLE public.imagenes_publicacion (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    publicacion_id UUID NOT NULL REFERENCES public.publicaciones(id) ON DELETE CASCADE,
    url_imagen TEXT NOT NULL,
    orden INTEGER NOT NULL DEFAULT 0,
    fecha_creacion TIMESTAMP WITH TIME ZONE DEFAULT now() NOT NULL,
    descripcion TEXT
);

-- Índices para mejor rendimiento
CREATE INDEX idx_publicaciones_autor ON public.publicaciones(autor_id);
CREATE INDEX idx_publicaciones_estado ON public.publicaciones(estado);
CREATE INDEX idx_imagenes_publicacion ON public.imagenes_publicacion(publicacion_id);

-- Políticas de seguridad RLS para publicaciones
ALTER TABLE public.publicaciones ENABLE ROW LEVEL SECURITY;

-- Permitir a todos los usuarios autenticados ver publicaciones publicadas
CREATE POLICY "Permitir lectura de publicaciones publicadas" 
ON public.publicaciones 
FOR SELECT 
TO authenticated 
USING (estado = 'publicado');

-- Permitir a los administradores ver todas las publicaciones
CREATE POLICY "Permitir a administradores ver todas las publicaciones"
ON public.publicaciones
FOR SELECT
TO authenticated
USING (auth.jwt() ->> 'role' = 'admin');

-- Permitir a los autores ver sus propias publicaciones
CREATE POLICY "Permitir a los autores ver sus publicaciones"
ON public.publicaciones
FOR SELECT
TO authenticated
USING (auth.uid() = autor_id);

-- Permitir a los administradores y autores crear publicaciones
CREATE POLICY "Permitir crear publicaciones a administradores"
ON public.publicaciones
FOR INSERT
TO authenticated
WITH CHECK (auth.jwt() ->> 'role' = 'admin');

-- Permitir a los autores actualizar sus propias publicaciones
CREATE POLICY "Permitir a los autores actualizar sus publicaciones"
ON public.publicaciones
FOR UPDATE
TO authenticated
USING (auth.uid() = autor_id)
WITH CHECK (auth.uid() = autor_id);

-- Permitir a los administradores actualizar cualquier publicación
CREATE POLICY "Permitir a administradores actualizar cualquier publicación"
ON public.publicaciones
FOR UPDATE
TO authenticated
USING (auth.jwt() ->> 'role' = 'admin')
WITH CHECK (auth.jwt() ->> 'role' = 'admin');

-- Políticas de seguridad RLS para imágenes de publicaciones
ALTER TABLE public.imagenes_publicacion ENABLE ROW LEVEL SECURITY;

-- Permitir ver imágenes de publicaciones públicas
CREATE POLICY "Permitir ver imágenes de publicaciones públicas"
ON public.imagenes_publicacion
FOR SELECT
TO authenticated
USING (
    EXISTS (
        SELECT 1 FROM public.publicaciones p 
        WHERE p.id = publicacion_id 
        AND (p.estado = 'publicado' OR p.autor_id = auth.uid() OR auth.jwt() ->> 'role' = 'admin')
    )
);

-- Permitir a los administradores y autores gestionar imágenes
CREATE POLICY "Permitir gestionar imágenes a administradores"
ON public.imagenes_publicacion
FOR ALL
TO authenticated
USING (auth.jwt() ->> 'role' = 'admin')
WITH CHECK (auth.jwt() ->> 'role' = 'admin');

-- Función para actualizar la fecha de actualización automáticamente
CREATE OR REPLACE FUNCTION actualizar_fecha_actualizacion()
RETURNS TRIGGER AS $$
BEGIN
    NEW.fecha_actualizacion = now();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger para actualizar automáticamente la fecha de actualización
CREATE TRIGGER actualizar_fecha_publicacion
BEFORE UPDATE ON public.publicaciones
FOR EACH ROW
EXECUTE FUNCTION actualizar_fecha_actualizacion();

-- Función para obtener publicaciones con sus imágenes
CREATE OR REPLACE FUNCTION obtener_publicaciones_con_imagenes()
RETURNS TABLE (
    id UUID,
    titulo TEXT,
    contenido TEXT,
    fecha_publicacion TIMESTAMP WITH TIME ZONE,
    autor_id UUID,
    estado TEXT,
    imagenes JSONB
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        p.id,
        p.titulo,
        p.contenido,
        p.fecha_publicacion,
        p.autor_id,
        p.estado,
        COALESCE(
            (
                SELECT jsonb_agg(
                    jsonb_build_object(
                        'id', ip.id,
                        'url_imagen', ip.url_imagen,
                        'orden', ip.orden,
                        'descripcion', ip.descripcion
                    )
                    ORDER BY ip.orden
                )
                FROM public.imagenes_publicacion ip
                WHERE ip.publicacion_id = p.id
            ),
            '[]'::jsonb
        ) AS imagenes
    FROM 
        public.publicaciones p
    WHERE 
        p.estado = 'publicado' 
        OR p.autor_id = auth.uid() 
        OR auth.jwt() ->> 'role' = 'admin';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Función para insertar una nueva publicación con imágenes
CREATE OR REPLACE FUNCTION crear_publicacion_con_imagenes(
    p_titulo TEXT,
    p_contenido TEXT,
    p_estado TEXT DEFAULT 'borrador',
    p_imagenes JSONB DEFAULT '[]'::jsonb
)
RETURNS UUID AS $$
DECLARE
    nueva_publicacion_id UUID;
    img JSONB;
BEGIN
    -- Insertar la publicación
    INSERT INTO public.publicaciones (titulo, contenido, estado, autor_id)
    VALUES (p_titulo, p_contenido, p_estado, auth.uid())
    RETURNING id INTO nueva_publicacion_id;

    -- Insertar las imágenes si existen
    FOR img IN SELECT * FROM jsonb_array_elements(p_imagenes)
    LOOP
        INSERT INTO public.imagenes_publicacion (
            publicacion_id,
            url_imagen,
            orden,
            descripcion
        ) VALUES (
            nueva_publicacion_id,
            img->>'url_imagen',
            COALESCE((img->>'orden')::INTEGER, 0),
            img->>'descripcion'
        );
    END LOOP;

    RETURN nueva_publicacion_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Comentarios para documentación
COMMENT ON TABLE public.publicaciones IS 'Almacena las publicaciones del blog o noticias';
COMMENT ON COLUMN public.publicaciones.estado IS 'Estado de la publicación: borrador, publicado, archivado';
COMMENT ON TABLE public.imagenes_publicacion IS 'Almacena las imágenes asociadas a las publicaciones';
COMMENT ON COLUMN public.imagenes_publicacion.orden IS 'Orden de visualización de las imágenes en la publicación';